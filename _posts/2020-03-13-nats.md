---
title: "nats server and client"
date: 2020-03-13
categories: development
tags: Nats
toc: true
toc_sticky: true
---

Written By [KJ Jang](https://github.com/jjangchan), VCANUS

`Nats` 서버는 심플하고 안전한 고성능 오픈소스 메세징 시스템이다. 기본적으로 높은 성능과 확장성, 간단한 사용성을 고려하여 설계되었다.

## Installation
_Ubuntu18.04 기준_

### Nats server
```
sudo apt-get update
sudo apt-get -y upgrade
sudo wget https://github.com/nats-io/nats-server/releases/download/v2.1.4/nats-server-v2.1.4-linux-amd64.zip
unzip nats-server-v2.1.4-linux-amd64.zip
sudo cp nats-server-v2.1.4-linux-amd64/nats-server /usr/bin
```

### Nats Streaming Server
```
sudo apt-get update
sudo apt-get -y upgrade
sudo wget https://github.com/nats-io/nats-streaming-server/releases/download/v0.17.0/nats-streaming-server-v0.17.0-linux-amd64.zip
unzip nats-streaming-server-v0.17.0-linux-amd64.zip
sudo cp nats-streaming-server-v0.17.0-linux-amd64/nats-streaming-server /usr/bin
```
Server download [here](https://nats.io/download/)

## docker
_Ubuntu18.04 기준_
### Installation and run
```
sudo docker pull nats
sudo docker run nats -p 4222:4222
```

### Nats Doucker swarm
```
node1 : sudo docker swarm init
To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-3cn52uehfphwp2fe6wxijkd91st7ucgtrzzfanx4flwqurf2vy-1evrmzm310mxliwx02ykunmnp host(node1):2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.

nood2 : sudo docker swarm join --token SWMTKN-1-3cn52uehfphwp2fe6wxijkd91st7ucgtrzzfanx4flwqurf2vy-1evrmzm310mxliwx02ykunmnp host(node1):2377
node3 : sudo docker swarm join --token SWMTKN-1-3cn52uehfphwp2fe6wxijkd91st7ucgtrzzfanx4flwqurf2vy-1evrmzm310mxliwx02ykunmnp host(node1):2377
node1 : sudo docker network create --driver overlay nats-cluster-example
node1 : sudo docker service create --network nats-cluster-example --name nats-cluster-node-1 -p 4222:4222 -p 8222:8222 nats:1.0.0 -cluster nats://0.0.0.0:6222 -DV
```
## Client build
Client download [here](https://nats.io/download/nats-io/nats.c/)
### Nats client c/c++ build(window)

#### install : 
1. openssl
2. cmake 
3. https://github.com/nats-io/nats.c.git

```
//해당 소스 디렉터리에 build 폴더 생성 ex) nats_build
cd nats_build
cmake .. -DNATS_BUILD_STREAMING=OFF (nats Streaming API 빌드 하지 않음)
```
#### 결과 :
1. 솔루션 파일 생성됨
2. visual studio 에서 솔루션 All build
3. example 디렉터리에 lib , dll 파일 생성됨


### Nats client c/c++ build(mac os)

```
git clone https://github.com/nats-io/nats.c.git
cd nats.c
mkdir build
cd build
cmake -DNATS_BUILD_STREAMING=OFF .. // nats Streaming API 빌드 하지 않을 경우 -DNATS_BUILD_STREAMING=OFF
make
```
#### 결과 : 
1. nats 관련 라이브러리 생성 됨 (dir : /usr/local/lib)
2. nats 관련 include 생성 됨 (dir : /usr/local/include)

#### cmake or make error :
```
Undefined symbols for architecture x86_64:
  "_OPENSSL_init_ssl", referenced from:
      _nats_sslInit in nats.c.o
  "_OPENSSL_sk_free", referenced from:
      __finalCleanup in nats.c.o
  "_OPENSSL_sk_num", referenced from:
      _natsOptions_SetCATrustedCertificates in opts.c.o
  "_OPENSSL_sk_pop_free", referenced from:
      _natsOptions_SetCATrustedCertificates in opts.c.o
  "_OPENSSL_sk_value", referenced from:
      _natsOptions_SetCATrustedCertificates in opts.c.o
  "_SSL_CTX_set_options", referenced from:
      __getSSLCtx in opts.c.o
  "_SSL_get0_param", referenced from:
      __processConnInit in conn.c.o
  "_X509_VERIFY_PARAM_set1_host", referenced from:
      __processConnInit in conn.c.o
  "_X509_VERIFY_PARAM_set_hostflags", referenced from:
      __processConnInit in conn.c.o
```
#### 원인 : 
openssl 라이브러리 찾지 못함
#### 해결 :
openssl 라이브러리 절대경로를 cmake 할떄 명령어로 지정해 준다.
ex) cmake -DOPENSSL_ROOT_DIR=/usr/local/opt/openssl@1.1 ..
```
