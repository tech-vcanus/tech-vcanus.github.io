I"•?<p>Written By <a href="https://github.com/nurring">Nuri Na</a>, VCANUS</p>

<h2 id="overview">Overview</h2>

<p>Apache KafkaëŠ” ì˜¤í”ˆì†ŒìŠ¤ ë°ì´í„° ìŠ¤íŠ¸ë¦¼ í”Œë«í¼ìœ¼ë¡œ, ëŒ€ìš©ëŸ‰ ì‹¤ì‹œê°„ ë¡œê·¸ ì²˜ë¦¬ì— íŠ¹í™”ëœ ë©”ì‹œì§• ì‹œìŠ¤í…œì´ë‹¤.</p>

<p>ë©”ì‹œì§€ë¥¼ ë©”ëª¨ë¦¬ê°€ ì•„ë‹Œ íŒŒì¼ ì‹œìŠ¤í…œì— ì €ì¥í•˜ë©°, ë¶„ì‚°í˜• ì‹œìŠ¤í…œìœ¼ë¡œ ë…¸ë“œ ê³ ì¥ê³¼ ë°ì´í„° ì†ì‹¤ì— ëŒ€ë¹„í•œë‹¤.</p>

<p>consumerê°€ brokerë¡œë¶€í„° ì§ì ‘ ë©”ì‹œì§€ë¥¼ ê°€ì§€ê³  ê°€ëŠ” pull ë°©ì‹ìœ¼ë¡œ ë™ì‘, ìì‹ ì˜ ì²˜ë¦¬ ëŠ¥ë ¥ë§Œí¼ë§Œ ê°€ì ¸ê°€ê²Œ ëœë‹¤.</p>

<h2 id="concepts">Concepts</h2>

<p><img src="/assets/images/kafkaconcept.png" alt="kafkaconcept1" /></p>

<p><em>ì´ë¯¸ì§€ ì¶œì²˜ : [https://towardsdatascience.com/getting-started-with-apache-kafka-in-python-604b3250aa05]</em></p>

<p><img src="/assets/images/kafkacluster.png" alt="kafkaconcept1" /></p>

<p><em>ì´ë¯¸ì§€ ì¶œì²˜ : [https://towardsdatascience.com/getting-started-with-apache-kafka-in-python-604b3250aa05]</em></p>

<ul>
  <li>Producers : ë©”ì„¸ì§€ ìƒì‚°(ë°œí–‰: publish)ì„ ë‹´ë‹¹. í† í”½ì„ ì„ íƒí•˜ì—¬ ë°ì´í„°ë¥¼ ë°œí–‰í•œë‹¤.</li>
  <li>
    <p>Consumers : í† í”½ì„ ì„ íƒ êµ¬ë…í•˜ì—¬ ë°ì´í„°ë¥¼ ì†Œë¹„í•œë‹¤.</p>
  </li>
  <li>
    <p>Broker : ë©”ì„¸ì§€ êµí™˜ì„ ë‹´ë‹¹í•˜ëŠ” ëª¨ë“  ìš”ì†Œ. KafkaëŠ” ì‹±ê¸€ë…¸ë“œ í˜¹ì€ í´ëŸ¬ìŠ¤í„°ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆë‹¤.</p>
  </li>
  <li>
    <p>Topic</p>
  </li>
  <li>
    <p>Log : í•œ ê°œì˜ ë©”ì„¸ì§€</p>
  </li>
  <li>Offset : íŒŒí‹°ì…˜ ë‚´ì—ì„œ ê° ë©”ì„¸ì§€ê°€ ê°€ì§€ëŠ” Unique Id</li>
</ul>

<h2 id="zookeeper">Zookeeper</h2>

<p>Kafkaì˜ ìƒíƒœì™€ í´ëŸ¬ìŠ¤í„°ë¥¼ ê´€ë¦¬í•œë‹¤.</p>

<h2 id="basic-tutorials">Basic Tutorials</h2>

<h3 id="setting-up-and-running">Setting up and Running</h3>

<p><a href="https://kafka.apache.org/downloads">Apache Kafka website</a> ì—ì„œ ë°”ì´ë„ˆë¦¬ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ</p>

<p>JVMì–¸ì–´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ë¯€ë¡œ Java 7 ì´ìƒ ë²„ì „ì´ í•„ìš”í•¨</p>

<h3 id="starting-zookeeper">Starting Zookeeper</h3>

<p>KafkaëŠ” Zookeeperì— ì˜ì¡´í•˜ë¯€ë¡œ Zookeeperë¥¼ ë¨¼ì € êµ¬ë™í•œë‹¤.</p>

<p><em>Kafka ì„¤ì¹˜ ë””ë ‰í† ë¦¬ë¥¼ ${KAFKA_PATH}ë¡œ í†µì¼í•˜ì—¬ ê¸°ìˆ í•¨</em></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">KAFKA_PATH</span><span class="k">}</span>/bin/zookeeper-server-start.sh config/zookeeper.properties
</code></pre></div></div>

<p>â€‹</p>

<h3 id="starting-kafka">Starting Kafka</h3>

<p>Kafka ë¸Œë¡œì»¤ ì„œë²„ë¥¼ êµ¬ë™í•œë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">KAFKA_PATH</span><span class="k">}</span>/bin/kafka-server-start.sh config/server.properties
</code></pre></div></div>

<h3 id="create-topics">Create Topics</h3>

<p>ë©”ì„¸ì§€ëŠ” í† í”½ì— ì „ë‹¬ëœë‹¤. ë‹¤ìŒ ëª…ë ¹ì–´ëŠ” testë¼ëŠ” í† í”½ì„ ìƒì„±í•œë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">KAFKA_PATH</span><span class="k">}</span>/bin/kafka-topics.sh <span class="nt">--create</span> <span class="nt">--zookeeper</span> localhost:2181 <span class="nt">--replication-factor</span> 1 <span class="nt">--partitions</span> 1 <span class="nt">--topic</span> <span class="nb">test</span>
</code></pre></div></div>

<p>ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ìƒì„±ëœ í† í”½ì˜ ì „ì²´ ëª©ë¡ì„ í™•ì¸</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">KAFKA_PATH</span><span class="k">}</span>/bin/kafka-topics.sh <span class="nt">--list</span> <span class="nt">--zookeeper</span> localhost:2181
</code></pre></div></div>

<h3 id="delete-topics">Delete Topics</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">KAFKA_PATH</span><span class="k">}</span>/kafka-topics.sh <span class="nt">--delete</span> <span class="nt">--zookeeper</span> localhost:2181 <span class="nt">--replication-factor</span> 1 <span class="nt">--partition</span> 1 <span class="nt">--topic</span> <span class="nb">test</span>
</code></pre></div></div>

<h3 id="sending-messages">Sending Messages</h3>

<p><code class="highlighter-rouge">producer</code>ëŠ” í† í”½ì— ë©”ì„¸ì§€ë¥¼ ì „ì†¡í•œë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">${</span><span class="nv">KAFKA_PATH</span><span class="k">}</span>/bin/kafka-console-producer.sh <span class="nt">--broker-list</span> localhost:9092 <span class="nt">--topic</span> <span class="nb">test</span>
<span class="o">&gt;</span>Hello World
</code></pre></div></div>

<p><code class="highlighter-rouge">${KAFKA_PATH}/config/server.properties</code> ì„¤ì •íŒŒì¼ <code class="highlighter-rouge">listeners</code> ì— 9092í¬íŠ¸ê°€ ê¸°ë³¸ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆë‹¤. í•´ë‹¹ ë¸Œë¡œì»¤ì˜ test í† í”½ìœ¼ë¡œ ë©”ì„¸ì§€ê°€ ì „ì†¡ëœë‹¤.</p>

<p>ë³´ë‚¸ ë©”ì„¸ì§€ëŠ” ë¡œì»¬ ë””ìŠ¤í¬ì— ì €ì¥ëœë‹¤. ì„¤ì •íŒŒì¼ <code class="highlighter-rouge">log.dirs</code>ì—ì„œ ê²½ë¡œë¥¼ ì„¤ì •í•œë‹¤. ì €ì¥ëœ ë©”ì„¸ì§€ëŠ” ì†Œë¹„ë˜ë©´ì„œ ì‚¬ë¼ì§€ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ <code class="highlighter-rouge">log.retintion.hours</code> ì—ì„œ ì„¤ì •í•œ ì‹œê°„ ë§Œí¼ ìœ ì§€ëœë‹¤.</p>

<h3 id="consuming-messages">Consuming Messages</h3>

<p>ì •í•´ì§„ topic ì— producer ê°€ ë©”ì„¸ì§€ë¥¼ ë°œí–‰í•´ë†“ìœ¼ë©´ consumer ê°€ í•„ìš”í• ë•Œ í•´ë‹¹ ë©”ì„¸ì§€ë¥¼ ê°€ì ¸ê°„ë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># í•´ë‹¹ í† í”½ì— ì €ì¥ëœ ë©”ì„¸ì§€ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸°</span>
<span class="k">${</span><span class="nv">KAFKA_PATH</span><span class="k">}</span>/bin/kafka-console-consumer.sh <span class="nt">--bootstrap-server</span> localhost:9092 <span class="nt">--topic</span> <span class="nb">test</span> <span class="nt">--from-beginning</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">--from-beginning</code> ì„ ì œê±°í•˜ë©´ ì‹¤ì‹œê°„ ë°œìƒë˜ëŠ” ë©”ì„¸ì§€ë¥¼ ë°›ì•„ì˜¨ë‹¤.</p>

<h2 id="accessing-kafka-in-python">Accessing Kafka in Python</h2>

<p>RTSP í”„ë¡œí† ì½œë¡œ ì˜ìƒì„ ë°›ì•„ openCVë¡œ ë Œë”ë§, flask ì›¹ì„œë²„ë¥¼ ì´ìš©í•´ ì˜ìƒì„ ë„ìš°ëŠ” ì˜ˆì œ</p>

<h3 id="setting-up-libraries">Setting up libraries</h3>

<ol>
  <li>
    <p>íŒŒì´ì¬ ë²„ì¶”ì–¼ í™˜ê²½ì„ ì„¤ì •(<a href="[https://medium.com/@dan_kim/%ED%8C%8C%EC%9D%B4%EC%8D%AC-%EC%B4%88%EC%8B%AC%EC%9E%90%EB%A5%BC-%EC%9C%84%ED%95%9C-pip-%EA%B7%B8%EB%A6%AC%EA%B3%A0-virtualenv-%EC%86%8C%EA%B0%9C-a53512fab3c2](https://medium.com/@dan_kim/íŒŒì´ì¬-ì´ˆì‹¬ìë¥¼-ìœ„í•œ-pip-ê·¸ë¦¬ê³ -virtualenv-ì†Œê°œ-a53512fab3c2)">virtualenv ì°¸ê³ </a>)í•œë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>virtualenv <span class="nb">env</span>
<span class="nb">.</span> <span class="nb">env</span>/bin/activate
</code></pre></div>    </div>
  </li>
  <li>
    <p>íŒŒì´ì¬ì— í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•œë‹¤. ì¹´í”„ì¹´, OpneCV, Flask.</p>
  </li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>kafka-python opencv-contrib-python Flask
</code></pre></div></div>

<h3 id="producerpy">producer.py</h3>

<p>ProducerëŠ” RTSP ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„°ë¥¼ ì¹´í”„ì¹´ ì„œë²„ì— ë°œí–‰í•œë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">KafkaProducer</span>

<span class="n">topic</span> <span class="o">=</span> <span class="s">"rtsp-stream"</span> 

<span class="k">def</span> <span class="nf">publish_camera</span><span class="p">():</span>
    <span class="s">"""
    íŠ¹ì •í•œ í† í”½ì— ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ì„ ë°œí–‰í•œë‹¤. ì¹´í”„ì¹´ ì„œë²„ëŠ” localhost:9092
    """</span>

    <span class="c1"># Producerë¥¼ ì„¤ì •í•œë‹¤
</span>    <span class="n">producer</span> <span class="o">=</span> <span class="n">KafkaProducer</span><span class="p">(</span><span class="n">bootstrap_servers</span><span class="o">=</span><span class="s">'localhost:9092'</span><span class="p">)</span>

    <span class="n">gst</span> <span class="o">=</span> <span class="s">"rtsp://ì„œë²„ ip ì£¼ì†Œ"</span> <span class="c1"># ì˜ˆ) rtsp://192.168.0.108:8554/test
</span>    <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">gst</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            
            <span class="n">ret</span><span class="p">,</span> <span class="nb">buffer</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imencode</span><span class="p">(</span><span class="s">'.jpeg'</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span> <span class="c1">#bufferì— ì´ë¯¸ì§€ë¥¼ ë°›ì•„
</span>            <span class="n">producer</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span> <span class="nb">buffer</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span> <span class="c1">#ì„¤ì •í•œ producerì˜ í•´ë‹¹ í† í”½ìœ¼ë¡œ send
</span>            
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">Exiting."</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">cap</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="s">"""
    ProducerëŠ” rtsp ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„°ë¥¼ ì¹´í”„ì¹´ ì„œë²„ì— ë°œí–‰í•œë‹¤.
    """</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"publihing feed!"</span><span class="p">)</span>
    <span class="n">publish_camera</span><span class="p">()</span>
</code></pre></div></div>

<h3 id="consumerpy">consumer.py</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">render_template</span>
<span class="kn">from</span> <span class="nn">kafka</span> <span class="kn">import</span> <span class="n">KafkaConsumer</span>

<span class="c1"># Kafka Consumer ì‘ë™
</span><span class="n">topic</span> <span class="o">=</span> <span class="s">"rtsp-stream"</span>

<span class="n">consumer</span> <span class="o">=</span> <span class="n">KafkaConsumer</span><span class="p">(</span>
    <span class="n">topic</span><span class="p">,</span> 
    <span class="n">bootstrap_servers</span><span class="o">=</span><span class="p">[</span><span class="s">'localhost:9092'</span><span class="p">])</span>


<span class="c1"># Set the consumer in a Flask App
</span><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/video_feed'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span> <span class="c1"># /video_feedë¡œ í˜ì´ì§€ ì ‘ì†
</span><span class="k">def</span> <span class="nf">video_feed</span><span class="p">():</span>
    <span class="s">"""
    mimetypeìœ¼ë¡œ multipart/x-mixed-replaceë¥¼ ì„¤ì •
    Flaskì—ì„œ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ìƒˆ valueê°€ ê¸°ì¡´ ì´ë¯¸ì§€ë¥¼ ëŒ€ì²´
    (í™”ë©´ì˜ ì´ë¯¸ì§€ê°€ ìƒˆ ì´ë¯¸ì§€ë¡œ ì§€ì†ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸)
    """</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
        <span class="n">get_video_stream</span><span class="p">(),</span> 
        <span class="n">mimetype</span><span class="o">=</span><span class="s">'multipart/x-mixed-replace; boundary=frame'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_video_stream</span><span class="p">():</span>
    <span class="s">"""
    ì¹´í”„ì¹´ ì„œë²„ì—ì„œ ìŠ¤íŠ¸ë¦¬ë°ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ë°›ì•„ Flaskê°€ ì½ì„ ìˆ˜ ìˆëŠ” í¬ë§·ìœ¼ë¡œ ë³€ê²½
    """</span>
    <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">consumer</span><span class="p">:</span>
        <span class="k">yield</span> <span class="p">(</span><span class="n">b</span><span class="s">'--frame</span><span class="se">\r\n</span><span class="s">'</span>
               <span class="n">b</span><span class="s">'Content-Type: image/jpeg</span><span class="se">\r\n\r\n</span><span class="s">'</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">b</span><span class="s">'</span><span class="se">\r\n\r\n</span><span class="s">'</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</code></pre></div></div>

<h3 id="run">Run</h3>

<ol>
  <li>
    <p>Zookeeperì™€ Kafka ì„œë²„ë¥¼ êµ¬ë™í•œë‹¤. (Basic Tutorials ì°¸ê³ )</p>
  </li>
  <li>
    <p>íŒŒì´ì¬ ë²„ì¶”ì–¼ í™˜ê²½ ì„¤ì • í›„ consumer.pyë¥¼ ì‹¤í–‰í•œë‹¤</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span> <span class="n">env</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">python</span> <span class="n">consumer</span><span class="o">.</span><span class="n">py</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>https://0.0.0.0:5000/video_feed ì ‘ì†</p>

    <p>í´ë¼ì´ì–¸íŠ¸ëŠ” ì„¤ì •í•œ í† í”½ìœ¼ë¡œë¶€í„° ë°ì´í„° ìŠ¤íŠ¸ë¦¼ì„ ë°›ì•„ì˜¤ì§€ë§Œ, í† í”½ì€ ì•„ì§ ë¹„ì–´ìˆìœ¼ë¯€ë¡œ ì•„ë¬´ê²ƒë„ ëœ¨ì§€ ì•ŠëŠ”ë‹¤.</p>
  </li>
  <li>
    <p>ìƒˆë¡œìš´ í„°ë¯¸ë„ì—ì„œ producer.pyë¥¼ ì‹¤í–‰í•œë‹¤.</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span> <span class="nb">env</span>/bin/activate
python producer.py
</code></pre></div>    </div>

    <p>í† í”½ì— ë°ì´í„°ê°€ ë°œí–‰ë¨ì— ë”°ë¼ https://0.0.0.0:5000/video_feed ì—ì„œë„ êµ¬ë…í•œ í† í”½ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³ , ìŠ¤íŠ¸ë¦¬ë° ì˜ìƒì´ ì¬ìƒëœë‹¤.</p>
  </li>
</ol>

:ET