I"<h1 id="elasticsearch-cluster-on-docker-compose">Elasticsearch cluster on Docker Compose</h1>

<p>Written By KYRoh(<a href="https://github.com/tsedek">github.com/tsedek</a>), VCANUS</p>

<h1 id="docker-compose">docker-compose</h1>

<h2 id="create-docker-composeyml">create docker-compose.yml</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$touch docker-compose.yml
</code></pre></div></div>

<h2 id="write-docker-compose">write docker-compose</h2>
<h3 id="breaking-changes-in-70-that-makes-elaticsearch-cluster-in-docker">Breaking changes in 7.0 that makes elaticsearch cluster in docker</h3>
<ul>
  <li>under 7.0 : “discovery.zen.ping.unicast.hosts” -&gt; up 7.0 : “discovery.seed_hosts”</li>
  <li>under 7.0 : “search.remote.connect” -&gt; up 7.0 : “cluster.remote.connect”</li>
  <li>under 7.0 : deprecated “discovery.zen.minimum_master_nodes” -&gt; up 7.0 : must defined “cluster.initial_master_nodes=masterNames”</li>
</ul>

<h3 id="fill-the-docker-composeyml-with-under-contents">Fill the docker-compose.yml with under contents</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '3.7'
services:
  esmaster: # Master (NO data)
    image: docker.elastic.co/elasticsearch/elasticsearch:7.4.0
    container_name: esmaster
    restart: always
    environment:
      - node.name=esmaster
      - cluster.name=docker-cluster
      - node.master=true
        #      - node.voting_only=false
      - node.data=false
      - node.ingest=true
        #      - node.ml=false
      - cluster.remote.connect=false
      - bootstrap.memory_lock=true
      - cluster.initial_master_nodes=esmaster  
      - discovery.seed_hosts=esdata1,esdata2,esmaster
      - "ES_JAVA_OPTS=-Xms1g -Xmx1g"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./elasticsearch/es-master:/usr/share/elasticsearch/data
    ports:
      - 9200:9200
      - 9300:9300
    networks:
      - esnet
    stdin_open: true
    tty: true
  esdata1: # Data 1
    image: docker.elastic.co/elasticsearch/elasticsearch:7.4.0
    container_name: esdata1
    restart: always
    environment:
      - node.name=esdata1
      - cluster.name=docker-cluster
      - node.master=false
        #      - node.voting_only=false
      - node.data=true
      - node.ingest=false
        #      - node.ml=false
      - cluster.remote.connect=false
      - bootstrap.memory_lock=true
      - cluster.initial_master_nodes=esmaster
      - discovery.seed_hosts=esdata1,esdata2,esmaster
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./elasticsearch/es-data-1:/usr/share/elasticsearch/data
    ports:
      - 9201:9200
      - 9301:9300
    networks:
      - esnet
  esdata2: # Data 2
    image: docker.elastic.co/elasticsearch/elasticsearch:7.4.0
    container_name: esdata2
    restart: always
    environment:
      - node.name=esdata2
      - cluster.name=docker-cluster
      - node.master=false
        #      - node.voting_only=false
      - node.data=true
      - node.ingest=false
        #      - node.ml=false
      - cluster.remote.connect=false
      - bootstrap.memory_lock=true
      - cluster.initial_master_nodes=esmaster
      - discovery.seed_hosts=esdata1,esdata2,esmaster
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./elasticsearch/es-data-2:/usr/share/elasticsearch/data
    ports:
      - 9202:9200
      - 9302:9300
    networks:
      - esnet
  escoordinatioin: # Router #coordinating node
    image: docker.elastic.co/elasticsearch/elasticsearch:7.4.0
    container_name: escoordinatioin
    restart: always
    environment:
      - node.name=escoordinatioin
      - cluster.name=docker-cluster
      - node.master=false
      - node.voting_only=false
      - node.data=false
      - node.ingest=false
      - node.ml=false
      - cluster.remote.connect=false
      - bootstrap.memory_lock=true
      - cluster.initial_master_nodes=esmaster
      - discovery.seed_hosts=esdata1,esdata2,esmaster
      - "ES_JAVA_OPTS=-Xms4g -Xmx4g"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./elasticsearch/es-router:/usr/share/elasticsearch/data
    ports:
      - 9203:9200
      - 9303:9300
    networks:
      - esnet
  kibana:
    image: docker.elastic.co/kibana/kibana:7.4.0
    container_name: kibana
    restart: always
    environment:
      ELASTICSEARCH_HOSTS: http://esmaster:9200
    depends_on:
      - esmaster
      - esdata1
      - esdata2
      - esrouter
    networks:
      - esnet
    ports:
      - 5601:5601
networks:
  esnet:
</code></pre></div></div>

<h2 id="make-folder-for-docker-volumefor-permission">make folder for docker volume(for permission)</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$mkdir volume-folder-name[ex)es-data-1]
</code></pre></div></div>

<h2 id="run-docker-compose">run docker-compose</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$docker-compose up -d
</code></pre></div></div>

<h2 id="stop-docker-compose">stop docker-compose</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$docker-compose down
</code></pre></div></div>
:ET