I"Ñ2<p>Written By <a href="https://github.com/nurring">Nuri Na</a>, VCANUS</p>

<p>C++ í”„ë¡œì íŠ¸ì˜ í•¨ìˆ˜ë¥¼ C#ì— ê°€ì ¸ì™€ ì‚¬ìš©í•˜ë„ë¡ í™˜ê²½ ì„¤ì • í•˜ëŠ” ë²•.</p>

<ol>
  <li>ì™¸ë¶€ C++ API ë¥¼ í¬í•¨ì‹œì¼œ</li>
  <li>C++ ë™ì  ë¼ì´ë¸ŒëŸ¬ë¦¬(dll)ë¥¼ ìƒì„±í•˜ê³ </li>
  <li>C# í”„ë¡œì íŠ¸ì— Import í•œ í›„</li>
  <li>C++ê³¼ C#ê°„ ë°ì´í„° íƒ€ì…ì„ ë§ì¶°ì¤Œ.</li>
</ol>

<p>ì˜ˆì œì—ì„œ ì‚¬ìš©í•  íŒŒì¼ëª…ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>

<p>â€‹	ì™¸ë¶€ API: Somedll.h, Somedll.lib,</p>

<p>â€‹	C++ í”„ë¡œì íŠ¸: dynamic_example.h, dynamic_example.cpp</p>

<p>â€‹	C# í”„ë¡œì íŠ¸: dynamic_example.cp</p>

<h2 id="1-c-api-import">1. C++ API Import</h2>

<ol>
  <li>
    <p><strong>DLL ë™ì  ë¼ì´ë¸ŒëŸ¬ë¦¬ í”„ë¡œì íŠ¸ ìƒì„±</strong></p>

    <p><img src="/assets/images/2020-07-21.png" alt="dllproject" /></p>
  </li>
  <li>
    <p><strong>.h (í—¤ë”) íŒŒì¼ ë””ë ‰í„°ë¦¬ ì¶”ê°€í•˜ê¸°</strong></p>

    <p><u>ì†”ë£¨ì…˜ íƒìƒ‰ê¸° - í”„ë¡œì íŠ¸ëª… ìš°í´ë¦­ - ì†ì„± - C/C++ - ì¼ë°˜ - ì¶”ê°€ í¬í•¨ ë””ë ‰í„°ë¦¬</u></p>

    <p>ìƒëŒ€ ê²½ë¡œ(í˜„ì¬ í”„ë¡œì íŠ¸ ìœ„ì¹˜ ê¸°ì¤€) í˜¹ì€ ì ˆëŒ€ ê²½ë¡œë¥¼ ì ì–´ì¤€ë‹¤.</p>

    <p><em>ex) ../include</em></p>
  </li>
  <li>
    <p><strong>.lib (ì •ì  ë¼ì´ë¸ŒëŸ¬ë¦¬) íŒŒì¼ ë””ë ‰í„°ë¦¬ ì¶”ê°€í•˜ê¸°</strong></p>

    <p><u>ì†”ë£¨ì…˜ íƒìƒ‰ê¸° - í”„ë¡œì íŠ¸ëª… ìš°í´ë¦­ - ì†ì„± - ë§ì»¤ - ì…ë ¥ - ì¶”ê°€ ì¢…ì†ì„±</u></p>

    <p>ìƒëŒ€ í˜¹ì€ ì ˆëŒ€ ê²½ë¡œë¥¼ í¬í•¨í•œ .lib íŒŒì¼ëª… ì „ì²´ë¥¼ ì ì–´ì¤€ë‹¤.</p>

    <p><em>ex) ../lib/x86/Somedll.lib</em></p>
  </li>
  <li>
    <p><strong>.dll (ë™ì  ë¼ì´ë¸ŒëŸ¬ë¦¬) íŒŒì¼ ë””ë ‰í„°ë¦¬ ì¶”ê°€í•˜ê¸°</strong></p>

    <p><u>ì†”ë£¨ì…˜ íƒìƒ‰ê¸° - í”„ë¡œì íŠ¸ëª… ìš°í´ë¦­ - ì†ì„± - êµ¬ì„± ì†ì„± - ë””ë²„ê¹… - í™˜ê²½</u></p>

    <p>.dll íŒŒì¼ì´ í¬í•¨ ëœ ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì ì–´ ì¤€ë‹¤.</p>

    <p><code class="highlighter-rouge">PATH=íŒŒì¼ ê²½ë¡œ1;íŒŒì¼ ê²½ë¡œ2;%PATH%</code></p>

    <p><em>ex) PATH=../lib/x86;%PATH%</em></p>
  </li>
  <li>
    <p><strong>ì»´íŒŒì¼ ê²½ë¡œ ì„¤ì •</strong></p>

    <p><u>ì†”ë£¨ì…˜ íƒìƒ‰ê¸° - í”„ë¡œì íŠ¸ëª… ìš°í´ë¦­ - ì†ì„± - êµ¬ì„± ì†ì„± - ì¼ë°˜ - ì¶œë ¥ ë””ë ‰í† ë¦¬</u></p>

    <p>ë§¤í¬ë¡œë¥¼ ì°¸ê³ í•˜ì—¬ ê²½ë¡œë¥¼ ì„¤ì •í•œë‹¤.</p>

    <p><em>ex) $(SolutionDir)bin$(Configuration)\</em></p>
  </li>
</ol>

<h2 id="2-make-my-dll-file">2. Make my .DLL file</h2>

<p>1ì—ì„œ í¬í•¨ì‹œí‚¨ dllì„ includeí•˜ì—¬  .h, .cppíŒŒì¼ì„ ì‘ì„±í•œë‹¤.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// C++</span>
<span class="c1">// dynamic_example.h</span>
<span class="cp">#pragma once
#include "external_api_name.h"
#ifdef DYNAMICEXAMPLELIBRARIES_EXPORTS
#define DYNAMICEXAMPLELIBRARIES_API __declspec(dllexport)
#else
#define DYNAMICEXAMPLELIBRARIES_API __declspec(dllimport)
#endif
</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="n">DYNAMICEXAMPLELIBRARIES_API</span> <span class="kt">int</span> <span class="nf">test</span><span class="p">();</span>
</code></pre></div></div>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// C++</span>
<span class="c1">//dynamic_example.cpp</span>
<span class="cp">#include "pch.h"
#include "dynamic_example.h"
</span><span class="kt">int</span> <span class="nf">test</span><span class="p">(){</span>
    <span class="k">return</span> <span class="mi">123</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ì°¸ê³  ë§í¬: <a href="https://docs.microsoft.com/ko-kr/cpp/build/walkthrough-creating-and-using-a-dynamic-link-library-cpp?view=vs-2019">ìì²´ ë™ì  ì—°ê²° ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§Œë“¤ê¸° ë° ì‚¬ìš©(C++)</a></p>

<h2 id="3-import-to-c-project">3. Import to C# project</h2>

<p>C# í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ê³ ,</p>

<p>C#ì—ì„œ C++ í”„ë¡œì íŠ¸ë¥¼ ì§ì ‘ ì°¸ì¡°í•  ìˆ˜ë„ ìˆìœ¼ë‚˜, ì—¬ëŸ¬ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ê²½ìš° ëŸ°íƒ€ì„ ì˜µì…˜ì˜ ì¶©ëŒë¡œ ì»´íŒŒì¼ ì—ëŸ¬ í˜¹ì€ ì‹¤í–‰ ì¤‘ ì¤‘ë‹¨ í˜„ìƒì´ ë°œìƒí•  í™•ë¥ ì´ ë†’ë‹¤.</p>

<p>ê°™ì€ ì†”ë£¨ì…˜ì— í¬í•¨ì‹œí‚¤ë˜ <strong>ë¹Œë“œ í›„ ì´ë²¤íŠ¸</strong>ë¥¼ ì„¤ì •í•˜ì—¬ DLLì„ í•„ìš”í•œ ìœ„ì¹˜(í•´ë‹¹ C++ DLLì„ í¬í•¨í•´ì•¼ í•˜ëŠ” í”„ë¡œì íŠ¸ì˜ ë¹Œë“œ ê²½ë¡œ)ì— ë³µì‚¬í•˜ë„ë¡ í•œë‹¤.</p>

<p>ë§¤í¬ë¡œë¥¼ ì°¸ê³ í•˜ì—¬ ê²½ë¡œë¥¼ ì„¤ì •í•œë‹¤.</p>

<p><u>ì†”ë£¨ì…˜ íƒìƒ‰ê¸° - í”„ë¡œì íŠ¸(C++)ëª… ìš°í´ë¦­ - ì†ì„± - ë¹Œë“œ ì´ë²¤íŠ¸ - ë¹Œë“œ í›„ ì´ë²¤íŠ¸ - ëª…ë ¹ì¤„</u></p>

<p><em>ex) copy â€œ$(TargetDir)\dynamic_example.dllâ€  â€œ$(SolutionDir)dynamic_example_prj\bin\Debug\â€</em>
<em>copy â€œ$(TargetDir)\dynamic_example.libâ€  â€œ$(SolutionDir)dynamic_example_prj\bin\Debug\â€</em></p>

<h2 id="4-marshalling">4. Marshalling</h2>

<p>C++ì˜ í•¨ìˆ˜ë¥¼  C#ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ë°ì´í„° íƒ€ì…ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì„ Marshalling(ë§ˆìƒ¬ë§)ì´ë¼ê³  í•œë‹¤.</p>

<p>int ë“± ë³€í™˜ì´ í•„ìš”í•˜ì§€ ì•Šì€ ê²½ìš° ê·¸ëŒ€ë¡œ ì‚¬ìš©í•œë‹¤.</p>

<p>ì•„ë˜ëŠ” <strong>êµ¬ì¡°ì²´</strong>ì™€ <strong>ë°°ì—´</strong>ì˜ ì‚¬ìš© ì˜ˆì œ.  ë°ì´í„° íƒ€ì…ê³¼ í¬ì¸í„°, ì°¸ì¡°ìì˜ ë¬¸ë²•ì  ë³€í™”ì— ì£¼ëª©í•  ê²ƒ.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// C++</span>
<span class="c1">// dynamic_example.h (í—¤ë” íŒŒì¼)</span>
<span class="cp">#include &lt;Somedll.h&gt; //ì™¸ë¶€ API
</span><span class="p">...</span>
<span class="c1">// êµ¬ì¡°ì²´ ì„ ì–¸</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">DYNAMICEXAMPLELIBRARIES_API</span> <span class="n">_exampleStruct</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">b</span><span class="p">;</span>	
<span class="p">}</span> <span class="n">exampleStruct</span><span class="p">;</span>
<span class="p">...</span>

<span class="k">extern</span> <span class="s">"C"</span> <span class="n">DYNAMICEXAMPLELIBRARIES_API</span> <span class="kt">void</span> <span class="nf">test_external</span><span class="p">(</span><span class="n">exampleStruct</span><span class="o">*</span> <span class="n">exam</span><span class="p">);</span><span class="c1">//êµ¬ì¡°ì²´, í¬ì¸í„°</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="n">DYNAMICEXAMPLELIBRARIES_API</span> <span class="kt">void</span> <span class="nf">test_array</span><span class="p">(</span><span class="kt">int16_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array</span><span class="p">)[</span><span class="mi">10</span><span class="p">]);</span><span class="c1">//ë°°ì—´, ì°¸ì¡°ì</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// C++</span>
<span class="c1">// dynamic_example.cpp (ì†ŒìŠ¤ íŒŒì¼)</span>
<span class="p">...</span>
<span class="n">someStruct</span> <span class="n">someStr</span><span class="p">;</span> <span class="c1">//ì™¸ë¶€ API êµ¬ì¡°ì²´</span>
<span class="kt">int16_t</span> <span class="n">newarray</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

<span class="cm">/*ì™¸ë¶€ í•¨ìˆ˜ê°€ ë§Œë“¤ì–´ë‚´ëŠ” someStr êµ¬ì¡°ì²´ë¥¼ shallow copyí•˜ëŠ” ì˜ˆì œ*/</span>
<span class="kt">void</span> <span class="nf">test_external</span><span class="p">(</span><span class="n">exampleStruct</span><span class="o">*</span> <span class="n">exam</span><span class="p">){</span>
    <span class="n">external_func1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">someStr</span><span class="p">);</span><span class="c1">//ì™¸ë¶€ API í•¨ìˆ˜ external_func1</span>
    <span class="n">exam</span><span class="o">-&gt;</span><span class="n">a</span> <span class="o">=</span> <span class="n">external</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
    <span class="n">exam</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">=</span> <span class="n">external</span><span class="p">.</span><span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*ì™¸ë¶€ í•¨ìˆ˜ê°€ ë§Œë“¤ì–´ë‚´ëŠ” newarrayë¥¼ deep copyí•˜ëŠ” ì˜ˆì œ*/</span>
<span class="kt">void</span> <span class="nf">test_array</span><span class="p">(</span><span class="kt">int16_t</span><span class="p">(</span><span class="o">&amp;</span><span class="n">array</span><span class="p">)[</span><span class="mi">10</span><span class="p">]){</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">external_func2</span><span class="p">(</span><span class="n">newarray</span><span class="p">);</span><span class="c1">//ì™¸ë¶€ API í•¨ìˆ˜ external_func2</span>
	<span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">newarray</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">end</span><span class="p">(</span><span class="n">newarray</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">array</span><span class="p">));</span><span class="c1">//deep copy</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// C#</span>
<span class="c1">// dynamic_example.cs</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>
<span class="p">...</span>
<span class="p">[</span><span class="nf">StructLayout</span><span class="p">(</span><span class="n">LayoutKind</span><span class="p">.</span><span class="n">Sequential</span><span class="p">,</span> <span class="n">CharSet</span><span class="p">=</span><span class="n">CharSet</span><span class="p">.</span><span class="n">Unicode</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">struct</span> <span class="nc">exampleStruct</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">float</span> <span class="n">b</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">...</span>
    
<span class="c1">//Dll Import</span>
<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"dynamic_example.dll"</span><span class="p">,</span> <span class="n">CallingConvention</span> <span class="p">=</span> <span class="n">CallingConvention</span><span class="p">.</span><span class="n">Cdecl</span><span class="p">)]</span>
<span class="k">extern</span> <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">test_external</span><span class="p">(</span><span class="k">ref</span> <span class="n">exampleStruct</span> <span class="n">es</span><span class="p">);</span>
<span class="p">[</span><span class="nf">DllImport</span><span class="p">(</span><span class="s">"dynamic_example.dll"</span><span class="p">,</span> <span class="n">CallingConvention</span> <span class="p">=</span> <span class="n">CallingConvention</span><span class="p">.</span><span class="n">Cdecl</span><span class="p">)]</span>
<span class="k">extern</span> <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">test_array</span><span class="p">(</span>
    <span class="p">[</span><span class="nf">MarshalAs</span><span class="p">(</span><span class="n">UnmanagedType</span><span class="p">.</span><span class="n">LPArray</span><span class="p">,</span> <span class="n">SizeConst</span> <span class="p">=</span> <span class="m">10</span><span class="p">)]</span> <span class="kt">short</span><span class="p">[]</span> <span class="n">array</span><span class="p">);</span>

<span class="c1">//í•¨ìˆ˜ ì‚¬ìš©</span>
<span class="n">exampleStruct</span> <span class="n">example</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">exampleStruct</span><span class="p">();</span>
<span class="kt">short</span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">short</span><span class="p">[</span><span class="m">10</span><span class="p">];</span>
<span class="nf">test_external</span><span class="p">(</span><span class="k">ref</span> <span class="n">example</span><span class="p">);</span>
<span class="nf">test_array</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
</code></pre></div></div>

:ET